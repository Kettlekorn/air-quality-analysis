---
title: 'Air Quality and Chronic Obstructive Pulmonary Disease Across California Counties'
author: "Brandon Wu"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
**Null Hypothesis:** "There is no statistically significant correlation between PM10 concentration and COPD hospitalization rates."

**Compiling/Cleaning Air Quality Data:**

countUniqueCounties: counts the number of unique counties within Caifornia from the AQI dataset for clarification in the cleaning process.
```{r}

countUniqueCounties <- function(caData) {
  uniqueCountyCount <- length(unique(caData$County.Name))
  #Counts the length of the list of counties listed in column County.Name
  return(uniqueCountyCount)
}

```

processAqiYearly: filters AQI data for the state California, calculates the average AQI per county for the year, and prints the number of unique counties before returning the processed dataset:
```{r}

processAqiYearly <- function(fileName) {
  
  aqiData <- read.csv(fileName, stringsAsFactors = FALSE)
  #Replaced spaces with dots for easier formatting
  colnames(aqiData) <- gsub(" ", ".", colnames(aqiData))
  #Filter for California
  caData <- aqiData[aqiData$State.Name == "California", ]
  #Extract Year
  caData$Year <- substr(caData$Date.Local, 1, 4)
  #Compute yearly average AQI per county
  yearlyAqi <- aggregate(AQI ~ Year + County.Name, data = caData, FUN = mean, na.rm = TRUE)
  
  return(yearlyAqi)
}

```

Call dataset processing for each file of each year before combining into a single dataset:
```{r}

data1990 <- processAqiYearly("daily_81102_1990.csv")
data1991 <- processAqiYearly("daily_81102_1991.csv")
data1992 <- processAqiYearly("daily_81102_1992.csv")
data1993 <- processAqiYearly("daily_81102_1993.csv")
data1994 <- processAqiYearly("daily_81102_1994.csv")
data1995 <- processAqiYearly("daily_81102_1995.csv")
data1996 <- processAqiYearly("daily_81102_1996.csv")
data1997 <- processAqiYearly("daily_81102_1997.csv")
data1998 <- processAqiYearly("daily_81102_1998.csv")
data1999 <- processAqiYearly("daily_81102_1999.csv")
data2000 <- processAqiYearly("daily_81102_2000.csv")
data2001 <- processAqiYearly("daily_81102_2001.csv")
data2002 <- processAqiYearly("daily_81102_2002.csv")
data2003 <- processAqiYearly("daily_81102_2003.csv")
data2004 <- processAqiYearly("daily_81102_2004.csv")
data2005 <- processAqiYearly("daily_81102_2005.csv")
data2006 <- processAqiYearly("daily_81102_2006.csv")
data2007 <- processAqiYearly("daily_81102_2007.csv")
data2008 <- processAqiYearly("daily_81102_2008.csv")
data2009 <- processAqiYearly("daily_81102_2009.csv")
data2010 <- processAqiYearly("daily_81102_2010.csv")
data2011 <- processAqiYearly("daily_81102_2011.csv")
data2012 <- processAqiYearly("daily_81102_2012.csv")
data2013 <- processAqiYearly("daily_81102_2013.csv")
data2014 <- processAqiYearly("daily_81102_2014.csv")


AllYearsAqiCalifornia <- rbind(
  data1990, data1991, data1992, data1993, data1994, data1995,
  data1996, data1997, data1998, data1999, data2000, data2001,
  data2002, data2003, data2004, data2005, data2006, data2007,
  data2008, data2009, data2010, data2011, data2012, data2013,
  data2014
)

write.csv(AllYearsAqiCalifornia, "AllYearsAqiCA.csv", row.names = FALSE)

```

2.  Cleaning Hospitalization Data for rows with cases of COPD/Asthma

```{r}
#Importing dataset for hospitilizations by county in California
hospitalData <- read.csv("CAHospitalizations.csv" )

#Filter for entries with description "COPD or Asthma in Older Adults (Age 40+)"
COPDcases <- hospitalData[hospitalData$PQIDescription == "COPD or Asthma in Older Adults (Age 40+)", ]

print(COPDcases)

```

#Ensuring Count_ICD10 and Population_ICD10 are be integer values before totalling into OverallCount and OverallPopulation

```{r}

COPDcases$Count_ICD10 <- gsub("[^0-9]", "", COPDcases$Count_ICD10)
COPDcases$Population_ICD10 <- gsub("[^0-9]", "", COPDcases$Population_ICD10)
COPDcases$Count_ICD9 <- gsub("[^0-9]", "", COPDcases$Count_ICD9)
COPDcases$Population_ICD9 <- gsub("[^0-9]", "", COPDcases$Population_ICD9)

# Converting cleaned values to integers
COPDcases$Count_ICD10 <- as.integer(COPDcases$Count_ICD10)
COPDcases$Population_ICD10 <- as.integer(COPDcases$Population_ICD10)
COPDcases$Count_ICD9 <- as.integer(COPDcases$Count_ICD9)
COPDcases$Population_ICD9 <- as.integer(COPDcases$Population_ICD9)

print(COPDcases)

```

#Combine ICD9/10 data for added columns OverallCount, OverallPopulation. Also remove rows with Annotation Code 1 or if both ICD9/10 counts are unavailable. Also remove entries that are STATEWIDE.

```{r}

COPDcases$OverallCount <- ifelse(!is.na(COPDcases$Count_ICD10), COPDcases$Count_ICD10, COPDcases$Count_ICD9)
COPDcases$OverallPopulation <- ifelse(!is.na(COPDcases$Population_ICD10), COPDcases$Population_ICD10, COPDcases$Population_ICD9)

cleanedCOPDdata <- COPDcases[!(is.na(COPDcases$OverallPopulation) | COPDcases$OverallPopulation == 0), ]
cleanedCOPDdata <- cleanedCOPDdata[cleanedCOPDdata$County != "STATEWIDE", ]

cleanedCOPDdata <- cleanedCOPDdata[, c("Year", "County", "OverallCount", "OverallPopulation")]

print(cleanedCOPDdata)

```

Before completing data cleaning, I checked to find counties in COPD data but not in AQI data, or counties in AQI data but missing in COPD data

```{r}
fullAqiData <- read.csv("AllYearsAqiCA.csv")
fullAqiData
```

```{r}

copdCounties <- unique(cleanedCOPDdata$County)
aqiCounties <- unique(fullAqiData$County.Name)

missingInAqi <- setdiff(copdCounties, aqiCounties)

missingInCOPD <- setdiff(aqiCounties, copdCounties)

print("Counties in COPD data but missing in AQI data:")
print(missingInAqi)

print("Counties in AQI data but missing in COPD data:")
print(missingInCOPD)

```

Based on the above code block, Tuolumne and Alpine are present in the COPD dataset but are missing from the AQI dataset. To maintain consistency, I will exclude these counties from the COPD dataset for this analysis.

```{r}

cleanedCOPDdata <- cleanedCOPDdata[!(cleanedCOPDdata$County %in% c("Tuolumne", "Alpine")), ]
write.csv(cleanedCOPDdata, "cleanedCOPDdata.csv", row.names = FALSE)
```

Organize fullAqiData to prioritize alphabetical ordering in county names

```{r}

cleanedAqiData <- fullAqiData[order(fullAqiData$County.Name, fullAqiData$Year), ]
write.csv(cleanedAqiData, "cleanedAqiData.csv", row.names = FALSE)
```

```{r}
#Displaying COPD data with Tuolumne and Alpine excluded
cleanedCOPDdata
#Displaying AQI data ordered by county name
cleanedAqiData

```

```{r}
#Changed naming scheme for column County.Name for consistency
colnames(cleanedAqiData)[colnames(cleanedAqiData) == "County.Name"] <- "County"

#Initializing a dataset to include both cleaned AQI and COPD data
mergedData <- merge(cleanedCOPDdata, cleanedAqiData, by = c("County", "Year"), all = TRUE)

mergedData
write.csv(mergedData, "mergedData.csv", row.names = FALSE)

```

To more efficiently provide a summary of the combined data, view counts of entries available for analysis by county
```{r}
#COPD 
copdCounts <- as.data.frame(table(cleanedCOPDdata$County))
colnames(copdCounts) <- c("County", "COPD_Entries")

#AQI
aqiCounts <- as.data.frame(table(cleanedAqiData$County))
colnames(aqiCounts) <- c("County", "AQI_Entries")

#Both COPD and AQI
bothCounts <- as.data.frame(table(mergedData$County[!is.na(mergedData$OverallCount) & !is.na(mergedData$AQI)]))
colnames(bothCounts) <- c("County", "Both_Entries")

countyEntryCounts <- merge(copdCounts, aqiCounts, by = "County", all = TRUE)
countyEntryCounts <- merge(countyEntryCounts, bothCounts, by = "County", all = TRUE)

#0 for counties that are missing from one dataset
countyEntryCounts[is.na(countyEntryCounts)] <- 0
write.csv(countyEntryCounts, "countyEntryCounts.csv", row.names = FALSE)
countyEntryCounts


```
For accuracy and completeness, my data analysis includes only counties with 19 entries and 25 AQI entries where both COPD and AQI data are available
```{r}
countiesWithSpecificEntries <- countyEntryCounts$County[
  countyEntryCounts$Both_Entries == 10 &
  countyEntryCounts$COPD_Entries == 19 &
  countyEntryCounts$AQI_Entries == 25
]

countiesWithSpecificEntries

```

Function to perform linear regression tests for a county with a given gapPeriod value, returning summaries for count ~ AQI and count/population ~ AQI
```{r}
testLinearModels <- function(countyName, data, gapPeriod) {
  countyData <- subset(data, County == countyName)
  
  countyData$LaggedAQI <- c(rep(NA, gapPeriod), countyData$AQI[1:(nrow(countyData) - gapPeriod)])
  
  
  model1 <- lm(OverallCount ~ LaggedAQI, data = countyData)
  model2 <- lm((OverallCount / OverallPopulation) ~ LaggedAQI, data = countyData)

  return(list(CountModel = summary(model1), CountPopModel = summary(model2)))
}

```

Function to extract p-value from a linear model
```{r}
getPValue <- function(model) {
  coefs <- model$coefficients
  return(coefs[2, 4])
}
```

Function to iterate through each given county and extract p values for gap periods 1-9
```{r}
extractPValuesForCounties <- function(counties, data) {
  results <- data.frame(County = character(), GapPeriod = integer(), Model = character(), PValue = numeric())
  #Iterate through each county
  for (county in counties) {
    #Loop through gap periods from 1 to 9
    for (gap in 1:9) {
      #Run the linear models for the given county and gap period
      modelResults <- testLinearModels(county, data, gap)
        #Extract p-values from the models
        pValueCount <- getPValue(modelResults$CountModel)
        pValueCountPop <- getPValue(modelResults$CountPopModel)
        #Append results for the "Count" and "Count/Population" models to the results data frame
        results <- rbind(results, data.frame(County = county, GapPeriod = gap, Model = "Count", PValue = pValueCount))
        results <- rbind(results, data.frame(County = county, GapPeriod = gap, Model = "Count/Population", PValue = pValueCountPop))
    }
  }
  return(results)
}

```

Remove entries with p values > 0.05. Out of 648 entries, 211 had values less than 0.05
```{r}
allpValuesDF <- extractPValuesForCounties(countiesWithSpecificEntries, mergedData)
allpValuesDF

#Filter to only show entries with statistically significant p-values
pValuesDF <- allpValuesDF[allpValuesDF$PValue <= 0.05, ]
pValuesDF
write.csv(pValuesDF, "pValuesDF.csv", row.names = FALSE)

```


```{r}
barplot(table(pValuesDF$GapPeriod[pValuesDF$Model == "Count"]), 
        xlab = "Gap Period",
        ylab = "Frequency",
        main = "Significant P-Values (Count)")

barplot(table(pValuesDF$GapPeriod[pValuesDF$Model == "Count/Population"]), 
        xlab = "Gap Period",
        ylab = "Frequency",
        main = "Significant P-Values (Count/Population)")

```
Only ~33% of the models show significant results. However, considering the limited scope of these specific cases, I've implemented the Benjamini-Hochberg to rule out false positives before determining the validity of my null hypothesis.

```{r}

bhProcedure <- function(dataFrame, fdrLevel = 0.05) {
  #Sorting the dataframe by p-values in ascending order
  dataFrame <- dataFrame[order(dataFrame$PValue), ]
  
  totalPValues <- nrow(dataFrame)
  
  #Assigning a rank to each p-value 
  dataFrame$Rank <- seq_len(totalPValues)
  
  #Formula: BHThreshold = (Rank / Total P-Values) * fdrLevel
  dataFrame$BHThreshold <- (dataFrame$Rank / totalPValues) * fdrLevel
  
  #Save the index of the largest rank p-value still within the threshold
  significantIndex <- max(which(dataFrame$PValue <= dataFrame$BHThreshold), na.rm = TRUE)
  
  #Mark p-values as significant if their rank is less than/equal to the highest significant p-value index
  dataFrame$Significant <- dataFrame$Rank <= significantIndex
  
  return(dataFrame)
}

```

To visualize by making a frequency plot, I've narrowed down the results to entries with TRUE significance to identify any further patterns.
```{r}
#Subset data for Model == "Count"
pValuesCount <- allpValuesDF[allpValuesDF$Model == "Count", ]
pValuesCount <- bhProcedure(pValuesCount)
write.csv(pValuesCount, "pValuesCount.csv", row.names = FALSE)

#Subset data for Model == "Count/Population"
pValuesCountPop <- allpValuesDF[allpValuesDF$Model == "Count/Population", ]
pValuesCountPop <- bhProcedure(pValuesCountPop)
write.csv(pValuesCountPop, "pValuesCountPop.csv", row.names = FALSE)


print(pValuesCount)
trueCount <- pValuesCount[pValuesCount$Significant == TRUE, ]
trueCount
print(pValuesCountPop)
trueCountPop <- pValuesCountPop[pValuesCountPop$Significant == TRUE, ]
trueCountPop

```

```{r}
#Generate frequency tables for each county from trueCount and trueCountPop
trueCountPlot <- table(trueCount$County)
trueCountPopPlot <- table(trueCountPop$County)

barplot(trueCountPlot,
        main = "Count",
        ylab = "Frequency",
        las = 2,  
        cex.names = 0.7)  

#Plot for Count/Population model
barplot(trueCountPopPlot,
        main = "Count/Population",
        ylab = "Frequency",
        las = 2,
        cex.names = 0.7)

```
```{r}
library(usmap)
library(ggplot2)
library(maps)
#Merge trueCount and trueCountPop 
mergedPResults <- rbind(trueCount, trueCountPop)

#Counting the number of significant occurrences per county)
countyCounts <- table(mergedPResults$County)

#Convert to dataframe countyData
countyData <- data.frame(
  County = names(countyCounts),
  PCount = as.numeric(countyCounts)
)

#Converting to county names to lowercase for FIPS matching
countyData$County <- tolower(countyData$County)

#Get FIPS codes for California counties
countyData$fips <- fips("CA", countyData$County)

CAPPlot <- plot_usmap(
  regions = "counties",
  include = "CA",
  data = countyData,
  values = "PCount"
) +
  scale_fill_continuous(
    low = "white", high = "red", name = "Significant P-Values Count"
  ) +
  ggtitle("Significant P-Values by County in California") +
  theme(legend.position = "right")

CAPPlot

```
104 out of 648 entries show significant results, with certain counties like Marin, Shasta, and Santa Clara having higher frequencies. While significance is not entirely random, certain counties may have underlying factors such as demographics, environmental conditions, or healthcare access that contribute to the pattern. Since there is some evidence of a correlation between PM10 concentration and COPD hospitalization rates with a minor degree of randomness, the clustering of significant results in specific counties suggests that PM10 levels may be influencing hospitalization rates in certain regions.